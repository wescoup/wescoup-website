<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tony's Strategy Calculator: 2x2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="/static/css/styles.css" rel="stylesheet">
    <link href="/static/css/tennisstyles.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
    /* Capture-only: force visibility and contrast for html2canvas */
    #pdf-summary.pdf-capture-light,
    #pdf-summary.pdf-capture-light * {
      color: #000 !important;
      background: transparent !important;
      text-shadow: none !important;
      box-shadow: none !important;
      -webkit-text-fill-color: #000 !important;
    }
    </style>
</head>
<body class="tennis-tracker-body">
    <div class="tennis-tracker-container">
        <div class="tennis-tracker-header">
            <h1>üéæ Tony's Strategy Calculator: 2x2</h1>
            <p class="subtitle-text">Find your optimal strategy in a game of wits.</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="tab-nav">
            <button class="btn btn-secondary" onclick="showSection('setup-section')">Setup</button>
            <button class="btn btn-secondary" onclick="showSection('matrix-section')">Matrix</button>
            <button class="btn btn-secondary" onclick="showSection('results-section')">Results</button>
            <button class="btn btn-secondary" onclick="showSection('saved-section')">Saved</button>
        </div>

        <!-- SETUP -->
        <div id="setup-section" class="tennis-section active">
            <h2 class="section-title">Setup</h2>
            <div class="team-setup-grid">
                <div class="team-card team-1-bg">
                    <h3 class="team-title-blue">üîµ Player 1</h3>
                    <div class="tennis-form-group">
                        <label for="player1-name">Name:</label>
                        <input type="text" id="player1-name" value="Player 1">
                    </div>
                    <div class="tennis-form-group">
                        <label for="player1-option1">Option 1:</label>
                        <input type="text" id="player1-option1" value="Serve Wide">
                    </div>
                    <div class="tennis-form-group">
                        <label for="player1-option2">Option 2:</label>
                        <input type="text" id="player1-option2" value="Serve T">
                    </div>
                </div>
                
                <div class="team-card team-2-bg">
                    <h3 class="team-title-red">üî¥ Player 2</h3>
                    <div class="tennis-form-group">
                        <label for="player2-name">Name:</label>
                        <input type="text" id="player2-name" value="Player 2">
                    </div>
                    <div class="tennis-form-group">
                        <label for="player2-option1">Option 1:</label>
                        <input type="text" id="player2-option1" value="Cover Wide">
                    </div>
                    <div class="tennis-form-group">
                        <label for="player2-option2">Option 2:</label>
                        <input type="text" id="player2-option2" value="Cover T">
                    </div>
                </div>
            </div>

            <div class="tennis-form-group mt-3">
                <label for="scenario-name">Scenario Name:</label>
                <input type="text" id="scenario-name" value="My Strategy Scenario">
            </div>

            <div class="btn-row mt-3">
                <button class="btn btn-primary" onclick="showSection('matrix-section')">Next: Matrix ‚Üí</button>
            </div>
        </div>

        <!-- MATRIX -->
        <div id="matrix-section" class="tennis-section">
            <h2 class="section-title">Payoff Matrix</h2>

            <div class="matrix-card">
                <table class="results-table" style="text-align:center; width:100%;">
                    <thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th colspan="2">üî¥ <span id="p2NameHeader">Player 2</span></th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th id="p2Opt1Header">Cover Wide</th>
                            <th id="p2Opt2Header">Cover T</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th rowspan="2">üîµ <span id="p1NameHeader">Player 1</span></th>
                            <th id="p1Opt1Header">Serve Wide</th>
                            <td><input type="number" id="payoff-0-0" class="form-control" value="45"></td>
                            <td><input type="number" id="payoff-0-1" class="form-control" value="70"></td>
                        </tr>
                        <tr>
                            <th id="p1Opt2Header">Serve T</th>
                            <td><input type="number" id="payoff-1-0" class="form-control" value="30"></td>
                            <td><input type="number" id="payoff-1-1" class="form-control" value="55"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="btn-row mt-3">
                <button class="btn btn-secondary" onclick="showSection('setup-section')">‚Üê Back</button>
                <button class="btn btn-primary" onclick="calculateStrategy()">Calculate</button>
                <button class="btn btn-secondary" onclick="showSection('results-section')">Next: Results ‚Üí</button>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="results-section" class="tennis-section">
            <h2 class="section-title">Results</h2>

            <div id="results-content">
                <div class="row">
                    <div class="col-md-6">
                        <h3>üîµ Player 1 Strategy</h3>
                        <p id="p1-strategy-display">Run a calc to see strategy‚Ä¶</p>
                    </div>
                    <div class="col-md-6">
                        <h3>üî¥ Player 2 Strategy</h3>
                        <p id="p2-strategy-display">Run a calc to see strategy‚Ä¶</p>
                    </div>
                </div>
            </div>

            <div class="btn-row mt-3">
                <button class="btn btn-secondary" onclick="showSection('matrix-section')">‚Üê Back</button>
                <button class="btn btn-success" onclick="saveCalculation()">Save</button>
                <button class="btn btn-outline-primary" onclick="generatePdf()">Save as PDF</button>
            </div>
        </div>

        <!-- SAVED -->
        <div id="saved-section" class="tennis-section">
            <h2 class="section-title">Saved Calculations</h2>
            <div id="saved-calcs-list">
            </div>
        </div>

        <!-- HIDDEN: PDF Summary View -->
        <div id="pdf-summary" class="tennis-section" style="display: none;">
            <h2 class="section-title" id="pdf-scenario-title">Scenario Name - 2025-01-01</h2>
            
            <h3 style="color: #FFE135; margin-top: 2rem;">Players & Options</h3>
            <div class="team-setup-grid" style="margin-bottom: 1rem;">
                <div class="team-card team-1-bg">
                    <h4 class="team-title-blue" id="pdf-p1-name">üîµ Player 1</h4>
                    <p>Option 1: <span id="pdf-p1-opt1">Serve Wide</span></p>
                    <p>Option 2: <span id="pdf-p1-opt2">Serve T</span></p>
                </div>
                <div class="team-card team-2-bg">
                    <h4 class="team-title-red" id="pdf-p2-name">üî¥ Player 2</h4>
                    <p>Option 1: <span id="pdf-p2-opt1">Cover Wide</span></p>
                    <p>Option 2: <span id="pdf-p2-opt2">Cover T</span></p>
                </div>
            </div>

            <h3 style="color: #FFE135; margin-top: 1rem;">Payoff Matrix</h3>
            <div id="pdf-matrix-container" style="margin-bottom: 1rem;"></div>

            <h3 style="color: #FFE135; margin-top: 1rem;">Optimal Mixed Strategies</h3>
            <div class="row">
                <div class="col-md-6">
                    <h4>üîµ <span id="pdf-result-p1-name">Player 1</span></h4>
                    <p id="pdf-result-p1-strategy"></p>
                </div>
                <div class="col-md-6">
                    <h4>üî¥ <span id="pdf-result-p2-name">Player 2</span></h4>
                    <p id="pdf-result-p2-strategy"></p>
                </div>
            </div>
        </div>

    </div>

    <script>
    // --- Simple state model ---
    const calculationData = {
        id: null,
        scenarioName: '',
        date: '',
        players: {
            player1: { name: '', options: ['', ''] },
            player2: { name: '', options: ['', ''] }
        },
        payoffs: [[0,0],[0,0]],
        optimalStrategy: {
            player1: { p1: 0, p2: 0 },
            player2: { q1: 0, q2: 0 }
        }
    };

    function showSection(id) {
        document.querySelectorAll('.tennis-section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function calculateStrategy() {
        // Read inputs
        const p1Name = document.getElementById('player1-name').value.trim() || 'Player 1';
        const p2Name = document.getElementById('player2-name').value.trim() || 'Player 2';
        const p1Opt1 = document.getElementById('player1-option1').value.trim() || 'Option 1';
        const p1Opt2 = document.getElementById('player1-option2').value.trim() || 'Option 2';
        const p2Opt1 = document.getElementById('player2-option1').value.trim() || 'Option 1';
        const p2Opt2 = document.getElementById('player2-option2').value.trim() || 'Option 2';

        const m00 = +document.getElementById('payoff-0-0').value || 0;
        const m01 = +document.getElementById('payoff-0-1').value || 0;
        const m10 = +document.getElementById('payoff-1-0').value || 0;
        const m11 = +document.getElementById('payoff-1-1').value || 0;

        // Update headers
        document.getElementById('p1NameHeader').textContent = p1Name;
        document.getElementById('p2NameHeader').textContent = p2Name;
        document.getElementById('p1Opt1Header').textContent = p1Opt1;
        document.getElementById('p1Opt2Header').textContent = p1Opt2;
        document.getElementById('p2Opt1Header').textContent = p2Opt1;
        document.getElementById('p2Opt2Header').textContent = p2Opt2;

        // Fake/simple strategy calc for demo (replace with real math)
        const p1p = 50, p2q = 50;

        calculationData.id = crypto.randomUUID();
        calculationData.scenarioName = document.getElementById('scenario-name').value.trim() || 'My Strategy Scenario';
        calculationData.date = new Date().toISOString().slice(0,10);
        calculationData.players.player1 = { name: p1Name, options: [p1Opt1, p1Opt2] };
        calculationData.players.player2 = { name: p2Name, options: [p2Opt1, p2Opt2] };
        calculationData.payoffs = [[m00, m01],[m10, m11]];
        calculationData.optimalStrategy = { player1: { p1: p1p, p2: 100-p1p }, player2: { q1: p2q, q2: 100-p2q } };

        document.getElementById('p1-strategy-display').textContent = `${p1Name}: ${p1p}% ${p1Opt1} / ${100-p1p}% ${p1Opt2}`;
        document.getElementById('p2-strategy-display').textContent = `${p2Name}: ${p2q}% ${p2Opt1} / ${100-p2q}% ${p2Opt2}`;

        showSection('results-section');
    }

    function saveCalculation() {
        // ... existing save logic (unchanged in this patch) ...
        alert('Saved (demo).');
    }

    function populatePdfSummary() {
        const calc = calculationData;
        
        // Title
        document.getElementById('pdf-scenario-title').textContent = `${calc.scenarioName} - ${calc.date}`;
        
        // Players & Options
        document.getElementById('pdf-p1-name').textContent = `üîµ ${calc.players.player1.name}`;
        document.getElementById('pdf-p1-opt1').textContent = calc.players.player1.options[0];
        document.getElementById('pdf-p1-opt2').textContent = calc.players.player1.options[1];
        document.getElementById('pdf-p2-name').textContent = `üî¥ ${calc.players.player2.name}`;
        document.getElementById('pdf-p2-opt1').textContent = calc.players.player2.options[0];
        document.getElementById('pdf-p2-opt2').textContent = calc.players.player2.options[1];
        
        // Matrix
        const matrixHtml = `
            <table class="results-table" style="text-align:center; border-collapse:collapse; margin: 0 auto;">
              <thead>
                <tr>
                  <th rowspan="2"></th>
                  <th rowspan="2"></th>
                  <th colspan="2">üî¥ ${calc.players.player2.name}</th>
                </tr>
                <tr>
                  <th>${calc.players.player2.options[0]}</th>
                  <th>${calc.players.player2.options[1]}</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th rowspan="2">üîµ ${calc.players.player1.name}</th>
                  <th>${calc.players.player1.options[0]}</th>
                  <td><strong>${calc.payoffs[0][0]}%</strong></td>
                  <td><strong>${calc.payoffs[0][1]}%</strong></td>
                </tr>
                <tr>
                  <th>${calc.players.player1.options[1]}</th>
                  <td><strong>${calc.payoffs[1][0]}%</strong></td>
                  <td><strong>${calc.payoffs[1][1]}%</strong></td>
                </tr>
              </tbody>
            </table>
        `;
        document.getElementById('pdf-matrix-container').innerHTML = matrixHtml;
        
        // Results
        document.getElementById('pdf-result-p1-name').textContent = calc.players.player1.name;
        document.getElementById('pdf-result-p2-name').textContent = calc.players.player2.name;
        document.getElementById('pdf-result-p1-strategy').innerHTML = `
            ${calc.players.player1.options[0]}: <strong>${calc.optimalStrategy.player1.p1}%</strong><br>
            ${calc.players.player1.options[1]}: <strong>${calc.optimalStrategy.player1.p2}%</strong>
        `;
        document.getElementById('pdf-result-p2-strategy').innerHTML = `
            ${calc.players.player2.options[0]}: <strong>${calc.optimalStrategy.player2.q1}%</strong><br>
            ${calc.players.player2.options[1]}: <strong>${calc.optimalStrategy.player2.q2}%</strong>
        `;
    }
        
    async function generatePdf() {
        if (!window.html2canvas || !(window.jspdf && window.jspdf.jsPDF)) {
            alert("PDF generation library is not loaded. Please ensure you are online."); 
            return;
        }
        if (!calculationData.id) {
            alert('Please calculate a strategy before generating a PDF.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const margin = 10;

        // Header text
        pdf.setFontSize(12);
        pdf.text("Tony's Strategy Calculator: 2x2", margin, margin);
        pdf.setFontSize(10);
        pdf.text(new Date().toLocaleString(), pdfWidth - 60, margin, { align: 'left' });
        pdf.setFontSize(11);
        pdf.text('wescoup.com/tonys-strategy-calculator-2x2', margin, margin + 6);
        
        document.body.classList.add('pdf-export-mode');
        
        // Populate and prepare the PDF summary view
        populatePdfSummary();
        const pdfSummary = document.getElementById('pdf-summary');
        const prevActive = document.querySelector('.tennis-section.active');
        if (prevActive) prevActive.classList.remove('active');
        pdfSummary.classList.add('active','pdf-capture-light');
        pdfSummary.style.setProperty('display','block','important');

        // Let styles/layout settle for two frames
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

        html2canvas(pdfSummary, {
            backgroundColor: '#ffffff',
            scale: 2,
            useCORS: true
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 0.92);
            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'JPEG', 0, margin + 10, pdfWidth, imgHeight);
            
            // Save with formatted filename
            const filename = `${calculationData.date} ${calculationData.scenarioName}.pdf`;
            pdf.save(filename);
        }).catch(error => {
            console.error('PDF generation error:', error);
            alert('Error generating PDF. Please try again.');
        }).finally(() => {
            // Restore UI
            pdfSummary.classList.remove('active','pdf-capture-light');
            pdfSummary.style.removeProperty('display');
            if (prevActive) prevActive.classList.add('active');
            document.body.classList.remove('pdf-export-mode');
        });
    }
    </script>
</body>
</html>
